<!-- Shared Header Component with Functional Notifications -->
<header class="h-20 border-b border-white/10 bg-brand-panel/95 backdrop-blur-md flex items-center justify-between px-8 z-30">
    <div class="flex items-center gap-4 text-sm text-zinc-500">
        <i data-lucide="home" class="w-4 h-4 text-zinc-600"></i>
        <i data-lucide="chevron-right" class="w-3 h-3 text-zinc-700"></i>
        <span id="page-title" class="text-brand-orange font-semibold capitalize tracking-wide text-lg">Dashboard</span>
    </div>
    <div class="flex items-center gap-6">
        <div class="h-6 w-px bg-white/10"></div>
        <button onclick="syncFromCloudflare()" class="flex items-center gap-2 px-3 py-1.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs font-medium transition-all text-zinc-300">
            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync
        </button>
        <!-- Notifications Dropdown -->
        <div class="relative" id="notifications-container">
            <button onclick="toggleNotifications()" class="p-2 hover:bg-white/5 rounded-full text-zinc-400 relative transition-all" id="notifications-button">
                <i data-lucide="bell" class="w-5 h-5"></i>
                <span id="notification-badge" class="absolute top-1.5 right-1.5 w-2 h-2 bg-brand-red rounded-full border-2 border-brand-panel hidden"></span>
            </button>
            <!-- Notifications Dropdown -->
            <div id="notifications-dropdown" class="absolute right-0 top-full mt-2 w-80 bg-brand-surface border border-white/10 rounded-xl shadow-2xl backdrop-blur-xl z-50 hidden" style="max-height: 480px; overflow-y: auto;">
                <div class="p-4 border-b border-white/10 flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-white">Notifications</h3>
                    <button onclick="markAllNotificationsRead()" class="text-xs text-zinc-400 hover:text-white transition-colors">Mark all read</button>
                </div>
                <div id="notifications-list" class="divide-y divide-white/5">
                    <div class="p-4 text-center text-zinc-500 text-sm">Loading notifications...</div>
                </div>
                <div class="p-3 border-t border-white/10 text-center">
                    <a href="/dashboard/messages" class="text-xs text-brand-orange hover:text-orange-400 transition-colors">View all notifications</a>
                </div>
            </div>
        </div>
        <button class="flex items-center gap-2 px-3 py-1.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs font-medium transition-all text-zinc-300">
            <i data-lucide="log-out" class="w-3 h-3"></i> Export
        </button>
    </div>
</header>

<script>
// Notifications functionality
let notificationsOpen = false;
let notifications = [];

async function loadNotifications() {
    try {
        const userId = getUserId(); // Get current user ID
        const tenantId = getTenantId(); // Get current tenant ID
        
        if (!userId || !tenantId) {
            console.log('No user/tenant ID available for notifications');
            return;
        }

        const response = await fetch(`${window.location.origin}/api/notifications?user_id=${userId}&tenant_id=${tenantId}&unread_only=true&limit=20`);
        const data = await response.json();
        
        if (data.success) {
            notifications = data.data || [];
            renderNotifications();
            updateNotificationBadge();
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function renderNotifications() {
    const list = document.getElementById('notifications-list');
    if (!list) return;
    
    if (notifications.length === 0) {
        list.innerHTML = '<div class="p-4 text-center text-zinc-500 text-sm">No notifications</div>';
        return;
    }
    
    list.innerHTML = notifications.map(notif => `
        <div class="p-4 hover:bg-white/5 transition-colors cursor-pointer ${notif.is_read ? '' : 'bg-white/5'}" onclick="handleNotificationClick('${notif.id}')">
            <div class="flex items-start gap-3">
                <div class="w-2 h-2 rounded-full mt-2 ${notif.is_read ? 'bg-transparent' : 'bg-brand-orange'}" style="flex-shrink: 0;"></div>
                <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium text-white mb-1">${escapeHtml(notif.title)}</div>
                    ${notif.message ? `<div class="text-xs text-zinc-400 line-clamp-2">${escapeHtml(notif.message)}</div>` : ''}
                    <div class="text-[10px] text-zinc-500 mt-2">${formatTime(notif.created_at)}</div>
                </div>
            </div>
        </div>
    `).join('');
    
    lucide.createIcons();
}

function updateNotificationBadge() {
    const badge = document.getElementById('notification-badge');
    if (!badge) return;
    
    const unreadCount = notifications.filter(n => !n.is_read).length;
    if (unreadCount > 0) {
        badge.classList.remove('hidden');
        badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
        badge.classList.remove('w-2', 'h-2');
        badge.classList.add('w-5', 'h-5', 'rounded-full', 'flex', 'items-center', 'justify-center', 'text-[10px]', 'font-bold', 'text-white');
    } else {
        badge.classList.add('hidden');
    }
}

function toggleNotifications() {
    notificationsOpen = !notificationsOpen;
    const dropdown = document.getElementById('notifications-dropdown');
    if (!dropdown) return;
    
    if (notificationsOpen) {
        dropdown.classList.remove('hidden');
        loadNotifications();
    } else {
        dropdown.classList.add('hidden');
    }
}

// Close notifications when clicking outside
document.addEventListener('click', (e) => {
    const container = document.getElementById('notifications-container');
    const button = document.getElementById('notifications-button');
    if (container && button && !container.contains(e.target)) {
        const dropdown = document.getElementById('notifications-dropdown');
        if (dropdown) dropdown.classList.add('hidden');
        notificationsOpen = false;
    }
});

async function markAllNotificationsRead() {
    try {
        const userId = getUserId();
        const tenantId = getTenantId();
        
        if (!userId || !tenantId) return;
        
        const response = await fetch(`${window.location.origin}/api/notifications/read-all`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, tenant_id: tenantId })
        });
        
        if (response.ok) {
            await loadNotifications();
        }
    } catch (error) {
        console.error('Error marking notifications read:', error);
    }
}

async function handleNotificationClick(notificationId) {
    try {
        const userId = getUserId();
        const tenantId = getTenantId();
        
        // Mark as read
        await fetch(`${window.location.origin}/api/notifications/${notificationId}/read`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, tenant_id: tenantId })
        });
        
        await loadNotifications();
        
        // Navigate based on notification type
        const notif = notifications.find(n => n.id === notificationId);
        if (notif && notif.data) {
            const data = typeof notif.data === 'string' ? JSON.parse(notif.data) : notif.data;
            if (data.url) {
                window.location.href = data.url;
            }
        }
    } catch (error) {
        console.error('Error handling notification click:', error);
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp * 1000);
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return date.toLocaleDateString();
}

function getUserId() {
    // Try to get from cookies, localStorage, or URL params
    const cookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [key, value] = cookie.trim().split('=');
        if (key && value) acc[key.trim()] = decodeURIComponent(value.trim());
        return acc;
    }, {});
    
    return cookies.user_id || localStorage.getItem('user_id') || new URLSearchParams(window.location.search).get('user_id');
}

function getTenantId() {
    const cookies = document.cookie.split(';').reduce((acc, cookie) => {
        const [key, value] = cookie.trim().split('=');
        if (key && value) acc[key.trim()] = decodeURIComponent(value.trim());
        return acc;
    }, {});
    
    return cookies.tenant_id || localStorage.getItem('tenant_id') || new URLSearchParams(window.location.search).get('tenant_id');
}

// Load notifications on page load
if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
        loadNotifications();
        // Refresh notifications every 30 seconds
        setInterval(loadNotifications, 30000);
    });
}
</script>
