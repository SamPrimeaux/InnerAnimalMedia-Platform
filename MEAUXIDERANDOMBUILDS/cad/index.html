<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MeauxCAD - Professional 2D/3D CAD Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <style>
        :root {
            --bg: #050505;
            --sidebar-bg: rgba(255, 255, 255, 0.9);
            --sidebar-border: rgba(255, 255, 255, 0.5);
            --sidebar-text: #475569;
            --sidebar-text-hover: #0f172a;
            --sidebar-active-bg: #0f172a;
            --sidebar-active-text: #2dd4bf;
            --border: #222;
            --primary: #2dd4bf;
            --text: #e5e5e5;
            --nav-w: 280px;
            --header-bg: rgba(255, 255, 255, 0.85);
            --header-border: rgba(0, 0, 0, 0.06);
            --header-text: #0f172a;
            --canvas-bg: #050505;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .sidenav {
            width: var(--nav-w);
            background: var(--sidebar-bg);
            backdrop-filter: blur(24px);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 50;
        }

        .resizer {
            position: absolute;
            right: -4px;
            top: 0;
            bottom: 0;
            width: 8px;
            cursor: col-resize;
            z-index: 100;
        }

        .brand {
            padding: 24px 28px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 800;
            font-size: 16px;
            color: #0f172a;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .brand .logo-square {
            width: 28px;
            height: 28px;
            background: #0f172a;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        .toolbar {
            padding: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tool-btn {
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            color: var(--sidebar-text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--sidebar-text-hover);
        }

        .tool-btn.active {
            background: var(--sidebar-active-bg);
            color: var(--sidebar-active-text);
            border-color: var(--sidebar-active-bg);
        }

        .nav-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .nav-section {
            margin-bottom: 24px;
        }

        .nav-header {
            font-size: 11px;
            font-weight: 800;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            padding: 0 4px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            color: var(--sidebar-text);
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .nav-item:hover {
            color: var(--sidebar-text-hover);
            background: rgba(0, 0, 0, 0.04);
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
        }

        .header {
            height: 72px;
            border-bottom: 1px solid var(--header-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            gap: 24px;
            color: var(--header-text);
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: var(--canvas-bg);
            overflow: hidden;
        }

        #canvas2d {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        #canvas3d {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
        }

        .view-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            z-index: 50;
        }

        .view-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            color: var(--header-text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--primary);
            color: #0f172a;
            border-color: var(--primary);
        }

        .status-bar {
            height: 32px;
            background: var(--header-bg);
            border-top: 1px solid var(--header-border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            font-size: 11px;
            color: #64748b;
            gap: 24px;
        }

        .top-toolbar {
            height: 56px;
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--header-border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 12px;
        }

        .top-toolbar .btn {
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            color: var(--header-text);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .top-toolbar .btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .top-toolbar .btn.primary {
            background: var(--primary);
            color: #0f172a;
            border-color: var(--primary);
        }

        .model-library {
            max-height: 300px;
            overflow-y: auto;
        }

        .model-item {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }

        .model-item:hover {
            background: rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="resizer" id="dragHandle"></div>
    <nav class="sidenav" id="sidebar">
        <div class="brand">
            <div class="logo-square">
                <svg width="16" height="16" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="metalGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#E8E8E8;stop-opacity:1" />
                            <stop offset="30%" style="stop-color:#F5F5F5;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#D0D0D0;stop-opacity:1" />
                            <stop offset="70%" style="stop-color:#B8B8B8;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#A0A0A0;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="metalHighlight" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#FFFFFF;stop-opacity:0.9" />
                            <stop offset="50%" style="stop-color:#FFFFFF;stop-opacity:0.4" />
                            <stop offset="100%" style="stop-color:#FFFFFF;stop-opacity:0" />
                        </linearGradient>
                        <filter id="bevel">
                            <feGaussianBlur in="SourceAlpha" stdDeviation="0.5"/>
                            <feOffset dx="0.5" dy="0.5" result="offsetblur"/>
                            <feComponentTransfer>
                                <feFuncA type="linear" slope="0.3"/>
                            </feComponentTransfer>
                            <feMerge>
                                <feMergeNode/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <path d="M4 4 L4 24 L8 16 L12 24 L16 16 L20 24 L20 4 L24 4 L24 24 L20 24 L16 16 L12 24 L8 24 L8 4 L12 4 Z" 
                          fill="url(#metalGradient)" 
                          filter="url(#bevel)"
                          stroke="#888" 
                          stroke-width="0.3"/>
                    <path d="M4 4 L8 4 L12 4 L16 16 L20 4 L24 4" 
                          stroke="url(#metalHighlight)" 
                          stroke-width="1.5" 
                          stroke-linecap="round"/>
                </svg>
            </div>
            Meaux<span style="color: var(--primary)">CAD</span>
        </div>

        <div class="toolbar">
            <div class="tool-btn active" data-tool="select" title="Select">
                <i data-lucide="mouse-pointer"></i>
            </div>
            <div class="tool-btn" data-tool="line" title="Line">
                <i data-lucide="minus"></i>
            </div>
            <div class="tool-btn" data-tool="rectangle" title="Rectangle">
                <i data-lucide="square"></i>
            </div>
            <div class="tool-btn" data-tool="circle" title="Circle">
                <i data-lucide="circle"></i>
            </div>
        </div>

        <div class="nav-content">
            <div class="nav-section">
                <div class="nav-header">3D Models</div>
                <div class="nav-item" onclick="scanR2Models()">
                    <i data-lucide="refresh-cw"></i> Scan CAD R2
                </div>
                <div class="nav-item" onclick="scanSplineicons()">
                    <i data-lucide="sparkles"></i> Scan Splineicons
                </div>
                <div id="modelLibrary" class="model-library"></div>
            </div>
            <div class="nav-section">
                <div class="nav-header">Themes</div>
                <div class="nav-item" onclick="loadThemes()">
                    <i data-lucide="palette"></i> Load Themes
                </div>
                <div id="themeList"></div>
            </div>
        </div>
    </nav>

    <main class="main">
        <div class="top-toolbar">
            <button class="btn" onclick="newProject()">
                <i data-lucide="file-plus" style="width:14px;height:14px;margin-right:6px;"></i> New
            </button>
            <button class="btn" onclick="openProject()">
                <i data-lucide="folder-open" style="width:14px;height:14px;margin-right:6px;"></i> Open
            </button>
            <button class="btn" onclick="saveProject()">
                <i data-lucide="save" style="width:14px;height:14px;margin-right:6px;"></i> Save
            </button>
            <div style="flex: 1;"></div>
            <button class="btn" onclick="exportProject()">
                <i data-lucide="download" style="width:14px;height:14px;margin-right:6px;"></i> Export
            </button>
        </div>

        <div class="canvas-container">
            <canvas id="canvas2d"></canvas>
            <canvas id="canvas3d"></canvas>
            <div class="view-toggle">
                <button class="view-btn active" onclick="switchView('2d')">2D</button>
                <button class="view-btn" onclick="switchView('3d')">3D</button>
            </div>
        </div>

        <div class="status-bar">
            <span id="statusCoords">X: 0, Y: 0</span>
            <span id="statusZoom">Zoom: 100%</span>
            <span id="statusMode">Mode: 2D</span>
            <span id="statusShapes">Shapes: 0</span>
        </div>
    </main>

    <script>
        lucide.createIcons();

        // Canvas setup
        const canvas2d = document.getElementById('canvas2d');
        const canvas3d = document.getElementById('canvas3d');
        const ctx2d = canvas2d.getContext('2d');
        
        let currentTool = 'select';
        let isDrawing = false;
        let startX, startY;
        let shapes = [];
        let selectedShape = null;
        let currentView = '2d';

        // Resize canvas
        function resizeCanvas() {
            const container = canvas2d.parentElement;
            canvas2d.width = container.clientWidth;
            canvas2d.height = container.clientHeight;
            canvas3d.width = container.clientWidth;
            canvas3d.height = container.clientHeight;
            drawGrid();
            redraw();
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Draw grid
        function drawGrid() {
            const gridSize = 20;
            ctx2d.strokeStyle = 'rgba(45, 212, 191, 0.1)';
            ctx2d.lineWidth = 1;
            
            for (let x = 0; x < canvas2d.width; x += gridSize) {
                ctx2d.beginPath();
                ctx2d.moveTo(x, 0);
                ctx2d.lineTo(x, canvas2d.height);
                ctx2d.stroke();
            }
            
            for (let y = 0; y < canvas2d.height; y += gridSize) {
                ctx2d.beginPath();
                ctx2d.moveTo(0, y);
                ctx2d.lineTo(canvas2d.width, y);
                ctx2d.stroke();
            }
        }

        // Tool selection
        document.querySelectorAll('.tool-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentTool = btn.dataset.tool;
                canvas2d.style.cursor = currentTool === 'select' ? 'default' : 'crosshair';
            });
        });

        // Canvas events
        canvas2d.addEventListener('mousedown', handleMouseDown);
        canvas2d.addEventListener('mousemove', handleMouseMove);
        canvas2d.addEventListener('mouseup', handleMouseUp);

        function handleMouseDown(e) {
            const rect = canvas2d.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            isDrawing = true;

            if (currentTool === 'select') {
                selectedShape = null;
                for (let i = shapes.length - 1; i >= 0; i--) {
                    if (isPointInShape(startX, startY, shapes[i])) {
                        selectedShape = shapes[i];
                        break;
                    }
                }
                redraw();
            }
        }

        function handleMouseMove(e) {
            const rect = canvas2d.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            document.getElementById('statusCoords').textContent = `X: ${Math.round(x)}, Y: ${Math.round(y)}`;

            if (isDrawing && currentTool !== 'select') {
                redraw();
                drawPreview(x, y);
            }
        }

        function handleMouseUp(e) {
            if (!isDrawing) return;
            
            const rect = canvas2d.getBoundingClientRect();
            const endX = e.clientX - rect.left;
            const endY = e.clientY - rect.top;

            if (currentTool !== 'select') {
                const minSize = 3;
                if (Math.abs(endX - startX) > minSize || Math.abs(endY - startY) > minSize) {
                    createShape(currentTool, startX, startY, endX, endY);
                    redraw();
                    updateShapeCount();
                }
            }
            
            isDrawing = false;
        }

        function createShape(type, x1, y1, x2, y2) {
            const shape = {
                id: Date.now(),
                type,
                x: Math.min(x1, x2),
                y: Math.min(y1, y2),
                width: Math.abs(x2 - x1),
                height: Math.abs(y2 - y1),
                color: '#2dd4bf',
                strokeWidth: 2
            };
            shapes.push(shape);
            console.log('Created shape:', shape, 'Total:', shapes.length);
            return shape;
        }

        function drawPreview(x, y) {
            ctx2d.strokeStyle = '#2dd4bf';
            ctx2d.lineWidth = 2;
            ctx2d.setLineDash([5, 5]);
            
            const w = x - startX;
            const h = y - startY;
            
            switch(currentTool) {
                case 'line':
                    ctx2d.beginPath();
                    ctx2d.moveTo(startX, startY);
                    ctx2d.lineTo(x, y);
                    ctx2d.stroke();
                    break;
                case 'rectangle':
                    ctx2d.strokeRect(startX, startY, w, h);
                    break;
                case 'circle':
                    const radius = Math.sqrt(w*w + h*h);
                    ctx2d.beginPath();
                    ctx2d.arc(startX, startY, radius, 0, Math.PI * 2);
                    ctx2d.stroke();
                    break;
            }
            ctx2d.setLineDash([]);
        }

        function redraw() {
            ctx2d.clearRect(0, 0, canvas2d.width, canvas2d.height);
            drawGrid();
            
            shapes.forEach(shape => {
                ctx2d.strokeStyle = shape.color;
                ctx2d.lineWidth = shape.strokeWidth;
                
                if (shape === selectedShape) {
                    ctx2d.setLineDash([5, 5]);
                } else {
                    ctx2d.setLineDash([]);
                }
                
                switch(shape.type) {
                    case 'line':
                        ctx2d.beginPath();
                        ctx2d.moveTo(shape.x, shape.y);
                        ctx2d.lineTo(shape.x + shape.width, shape.y + shape.height);
                        ctx2d.stroke();
                        break;
                    case 'rectangle':
                        ctx2d.strokeRect(shape.x, shape.y, shape.width, shape.height);
                        break;
                    case 'circle':
                        const radius = Math.max(shape.width, shape.height) / 2;
                        const cx = shape.x + shape.width/2;
                        const cy = shape.y + shape.height/2;
                        ctx2d.beginPath();
                        ctx2d.arc(cx, cy, radius, 0, Math.PI * 2);
                        ctx2d.stroke();
                        break;
                }
            });
        }

        function isPointInShape(x, y, shape) {
            switch(shape.type) {
                case 'rectangle':
                    return x >= shape.x && x <= shape.x + shape.width &&
                           y >= shape.y && y <= shape.y + shape.height;
                case 'circle':
                    const cx = shape.x + shape.width/2;
                    const cy = shape.y + shape.height/2;
                    const radius = Math.max(shape.width, shape.height) / 2;
                    return Math.sqrt((x-cx)**2 + (y-cy)**2) <= radius;
                case 'line':
                    const dist = Math.abs((shape.height * x - shape.width * y + (shape.x + shape.width) * shape.y - shape.x * (shape.y + shape.height)) / 
                                         Math.sqrt(shape.height**2 + shape.width**2));
                    return dist < 5;
                default:
                    return false;
            }
        }

        function updateShapeCount() {
            document.getElementById('statusShapes').textContent = `Shapes: ${shapes.length}`;
        }

        // View switching
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (view === '2d') {
                canvas2d.style.display = 'block';
                canvas3d.style.display = 'none';
                document.getElementById('statusMode').textContent = 'Mode: 2D';
            } else {
                canvas2d.style.display = 'none';
                canvas3d.style.display = 'block';
                init3D();
                document.getElementById('statusMode').textContent = 'Mode: 3D';
            }
        }

        // 3D Setup
        let scene, camera, renderer;
        function init3D() {
            if (renderer) return;
            
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, canvas3d.width / canvas3d.height, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas: canvas3d, antialias: true });
            renderer.setSize(canvas3d.width, canvas3d.height);
            renderer.setClearColor(0x050505);
            
            camera.position.set(5, 5, 5);
            camera.lookAt(0, 0, 0);
            
            const gridHelper = new THREE.GridHelper(20, 20, 0x2dd4bf, 0x1e293b);
            scene.add(gridHelper);
            
            const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            scene.add(directionalLight);
            
            animate3D();
        }

        function animate3D() {
            requestAnimationFrame(animate3D);
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // Project management
        function newProject() {
            if (confirm('Create a new project? Unsaved changes will be lost.')) {
                shapes = [];
                selectedShape = null;
                redraw();
                updateShapeCount();
            }
        }

        function saveProject() {
            const project = { shapes, view: currentView, timestamp: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `meauxcad-project-${Date.now()}.json`;
            a.click();
        }

        function openProject() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = JSON.parse(e.target.result);
                    shapes = project.shapes || [];
                    redraw();
                    updateShapeCount();
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function exportProject() {
            const format = prompt('Export format (svg, png):', 'svg');
            if (!format) return;
            if (format === 'svg') exportSVG();
            else if (format === 'png') exportPNG();
        }

        function exportSVG() {
            let svg = `<svg width="${canvas2d.width}" height="${canvas2d.height}" xmlns="http://www.w3.org/2000/svg">`;
            shapes.forEach(shape => {
                switch(shape.type) {
                    case 'rectangle':
                        svg += `<rect x="${shape.x}" y="${shape.y}" width="${shape.width}" height="${shape.height}" stroke="${shape.color}" stroke-width="${shape.strokeWidth}" fill="none"/>`;
                        break;
                    case 'circle':
                        const radius = Math.max(shape.width, shape.height) / 2;
                        svg += `<circle cx="${shape.x + shape.width/2}" cy="${shape.y + shape.height/2}" r="${radius}" stroke="${shape.color}" stroke-width="${shape.strokeWidth}" fill="none"/>`;
                        break;
                    case 'line':
                        svg += `<line x1="${shape.x}" y1="${shape.y}" x2="${shape.x + shape.width}" y2="${shape.y + shape.height}" stroke="${shape.color}" stroke-width="${shape.strokeWidth}"/>`;
                        break;
                }
            });
            svg += '</svg>';
            const blob = new Blob([svg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `meauxcad-export-${Date.now()}.svg`;
            a.click();
        }

        function exportPNG() {
            const url = canvas2d.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `meauxcad-export-${Date.now()}.png`;
            a.click();
        }

        // R2 Model Scanning
        async function scanR2Models() {
            const library = document.getElementById('modelLibrary');
            library.innerHTML = '<div style="padding:8px;color:#64748b;">Scanning CAD R2...</div>';
            
            try {
                const response = await fetch('/api/r2/scan?ext=glb');
                const data = await response.json();
                
                if (data.success && data.files.length > 0) {
                    library.innerHTML = '';
                    data.files.forEach(file => {
                        const item = document.createElement('div');
                        item.className = 'model-item';
                        item.innerHTML = `<i data-lucide="box" style="width:14px;height:14px;margin-right:8px;"></i>${file.name}`;
                        item.onclick = () => load3DModel(file.url);
                        library.appendChild(item);
                    });
                    lucide.createIcons();
                } else {
                    library.innerHTML = '<div style="padding:8px;color:#64748b;">No .glb files found</div>';
                }
            } catch (error) {
                library.innerHTML = '<div style="padding:8px;color:#ef4444;">Error scanning</div>';
            }
        }

        async function scanSplineicons() {
            const library = document.getElementById('modelLibrary');
            library.innerHTML = '<div style="padding:8px;color:#64748b;">Scanning Splineicons...</div>';
            
            try {
                const response = await fetch('/api/splineicons?action=list&ext=glb');
                const data = await response.json();
                
                if (data.success && data.files.length > 0) {
                    library.innerHTML = '';
                    data.files.forEach(file => {
                        const item = document.createElement('div');
                        item.className = 'model-item';
                        item.innerHTML = `<i data-lucide="box" style="width:14px;height:14px;margin-right:8px;"></i>${file.name}`;
                        item.onclick = () => load3DModel(file.url);
                        library.appendChild(item);
                    });
                    lucide.createIcons();
                } else {
                    library.innerHTML = '<div style="padding:8px;color:#64748b;">No GLB files found</div>';
                }
            } catch (error) {
                library.innerHTML = '<div style="padding:8px;color:#ef4444;">Error</div>';
            }
        }

        function load3DModel(url) {
            if (!scene) init3D();
            const loader = new THREE.GLTFLoader();
            loader.load(url, (gltf) => {
                scene.add(gltf.scene);
                renderer.render(scene, camera);
            }, undefined, (error) => {
                console.error('Error loading model:', error);
            });
        }

        // Theme Loading - Load ALL themes from database and CSS library
        async function loadThemes() {
            const themeList = document.getElementById('themeList');
            themeList.innerHTML = '<div style="padding:8px;color:#64748b;">Loading 52 themes...</div>';
            
            try {
                // Load from database
                const response = await fetch('/api/themes?public=true');
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    themeList.innerHTML = '';
                    
                    // Load the main theme library CSS first (contains all 46+ themes)
                    const libraryLink = document.createElement('link');
                    libraryLink.rel = 'stylesheet';
                    libraryLink.href = '/shared/themes/meaux-theme-library.css';
                    libraryLink.id = 'theme-library-css';
                    if (!document.getElementById('theme-library-css')) {
                        document.head.appendChild(libraryLink);
                    }
                    
                    // Also load premium themes CSS
                    const premiumLink = document.createElement('link');
                    premiumLink.rel = 'stylesheet';
                    premiumLink.href = '/shared/themes/meaux-tools-24-premium.css';
                    premiumLink.id = 'premium-themes-css';
                    if (!document.getElementById('premium-themes-css')) {
                        document.head.appendChild(premiumLink);
                    }
                    
                    // Display all themes from database
                    data.data.forEach(theme => {
                        const item = document.createElement('div');
                        item.className = 'nav-item';
                        item.style.cssText = 'padding:8px 12px;font-size:12px;';
                        item.innerHTML = `<i data-lucide="palette" style="width:14px;height:14px;"></i> ${theme.displayName || theme.name}`;
                        item.onclick = () => {
                            // Apply theme using data-theme attribute
                            document.documentElement.setAttribute('data-theme', theme.name);
                            document.body.setAttribute('data-theme', theme.name);
                            
                            // Also try to load individual CSS if it exists
                            const link = document.createElement('link');
                            link.rel = 'stylesheet';
                            link.href = `/shared/themes/${theme.name}.css`;
                            link.onerror = () => link.remove();
                            if (!document.querySelector(`link[href="/shared/themes/${theme.name}.css"]`)) {
                                document.head.appendChild(link);
                            }
                        };
                        themeList.appendChild(item);
                    });
                    
                    lucide.createIcons();
                } else {
                    themeList.innerHTML = '<div style="padding:8px;color:#64748b;">No themes found in database</div>';
                }
            } catch (error) {
                themeList.innerHTML = `<div style="padding:8px;color:#ef4444;">Error: ${error.message}</div>`;
                console.error('Theme loading error:', error);
            }
        }

        // Sidebar resizer
        const sidebar = document.getElementById('sidebar');
        const handle = document.getElementById('dragHandle');
        let isResizing = false;
        handle.addEventListener('mousedown', () => { 
            isResizing = true; 
            document.body.style.cursor = 'col-resize'; 
        });
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const w = Math.max(200, Math.min(e.clientX, 600));
            sidebar.style.width = w + 'px';
            document.documentElement.style.setProperty('--nav-w', w + 'px');
        });
        document.addEventListener('mouseup', () => { 
            isResizing = false; 
            document.body.style.cursor = 'default'; 
        });

        // Initialize
        redraw();
        updateShapeCount();
    </script>
</body>
</html>