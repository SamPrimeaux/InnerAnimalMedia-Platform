<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Calls | InnerAnimalMedia OS</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            orange: '#ff6b00',
                            red: '#dc2626',
                            dark: '#050507',
                            panel: '#0a0a0f',
                            surface: '#171717'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #050507;
            color: #f4f4f5;
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #ff6b00;
        }

        .glass-panel {
            background: rgba(23, 23, 23, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }

        #local-video,
        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
    </style>
    <link rel="stylesheet" href="/shared/themes/meaux-theme-library.css">
</head>

<body class="flex h-screen selection:bg-orange-500/30">

    <!-- SIDEBAR NAVIGATION (Shared) -->
    <aside id="sidebar"
        class="w-64 bg-brand-panel/95 backdrop-blur-md border-r border-white/10 flex flex-col transition-all duration-300 z-40 relative">
        <div class="h-20 flex items-center px-6 border-b border-white/5">
            <img src="https://imagedelivery.net/g7wf09fCONpnidkRnR_5vw/17535395-1501-490a-ff3d-e43d7c16a000/avatar"
                alt="InnerAnimalMedia" class="w-10 h-10 rounded-xl shrink-0 shadow-lg" />
            <div class="ml-3 sidebar-text">
                <h1 class="font-bold text-base tracking-tight text-white leading-tight">InnerAnimal</h1>
                <span class="text-[10px] text-zinc-500 font-mono tracking-wider">MEDIA OS v5.1</span>
            </div>
        </div>
        <nav class="flex-1 overflow-y-auto p-4 space-y-8 custom-scrollbar">
            <div>
                <div class="px-3 mb-3 text-[10px] font-bold text-zinc-600 uppercase tracking-widest sidebar-text">Hub
                </div>
                <div class="space-y-1">
                    <a href="/dashboard"
                        class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all hover:bg-white/5 text-zinc-400 hover:text-white"
                        data-page="overview">
                        <i data-lucide="home" class="w-4 h-4"></i> <span class="sidebar-text">Dashboard</span>
                    </a>
                    <a href="/dashboard/projects"
                        class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all hover:bg-white/5 text-zinc-400 hover:text-white"
                        data-page="projects">
                        <i data-lucide="briefcase" class="w-4 h-4"></i> <span class="sidebar-text">Projects</span>
                    </a>
                    <a href="/dashboard/clients"
                        class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all hover:bg-white/5 text-zinc-400 hover:text-white"
                        data-page="clients">
                        <i data-lucide="users" class="w-4 h-4"></i> <span class="sidebar-text">Clients</span>
                    </a>
                </div>
            </div>
            <div>
                <div class="px-3 mb-3 text-[10px] font-bold text-zinc-600 uppercase tracking-widest sidebar-text">
                    Community
                </div>
                <div class="space-y-1">
                    <a href="/dashboard/messages"
                        class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all hover:bg-white/5 text-zinc-400 hover:text-white"
                        data-page="messages">
                        <i data-lucide="message-square" class="w-4 h-4"></i> <span class="sidebar-text">Message
                            Board</span>
                    </a>
                    <a href="/dashboard/video"
                        class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all bg-brand-orange text-white shadow-lg shadow-orange-900/20"
                        data-page="video">
                        <i data-lucide="video" class="w-4 h-4"></i> <span class="sidebar-text">Video Calls</span>
                    </a>
                </div>
            </div>
            <div>
                <div class="px-3 mb-3 text-[10px] font-bold text-zinc-600 uppercase tracking-widest sidebar-text">Engine
                </div>
                <div class="space-y-1">
                    <a href="/dashboard/meauxmcp"
                        class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all hover:bg-white/5 text-zinc-400 hover:text-white"
                        data-page="meauxmcp">
                        <i data-lucide="server" class="w-4 h-4"></i> <span class="sidebar-text">MeauxMCP</span>
                    </a>
                    <a href="/dashboard/meauxsql"
                        class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all hover:bg-white/5 text-zinc-400 hover:text-white"
                        data-page="meauxsql">
                        <i data-lucide="database" class="w-4 h-4"></i> <span class="sidebar-text">MeauxSQL</span>
                    </a>
                </div>
            </div>
            <div>
                <div class="px-3 mb-3 text-[10px] font-bold text-zinc-600 uppercase tracking-widest sidebar-text">System
                </div>
                <div class="space-y-1">
                    <a href="/dashboard/settings"
                        class="nav-link w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-medium transition-all hover:bg-white/5 text-zinc-400 hover:text-white"
                        data-page="settings">
                        <i data-lucide="settings" class="w-4 h-4"></i> <span class="sidebar-text">Settings</span>
                    </a>
                </div>
            </div>
        </nav>
        <div class="p-4 border-t border-white/5">
            <div
                class="flex items-center gap-3 p-2 rounded-xl bg-white/5 hover:bg-white/10 cursor-pointer transition-all">
                <div
                    class="w-8 h-8 rounded-full bg-gradient-to-tr from-brand-orange to-brand-red flex items-center justify-center text-xs font-bold text-white shrink-0 ring-2 ring-brand-panel">
                    SP</div>
                <div class="flex-1 min-w-0 sidebar-text">
                    <div class="font-medium text-xs text-zinc-200">Sam Primeaux</div>
                    <div class="text-[10px] text-zinc-500 truncate">sam@inneranimal.com</div>
                </div>
            </div>
            <button onclick="app.toggleSidebar()"
                class="w-full flex items-center justify-center p-2 mt-2 rounded-lg hover:bg-white/5 text-zinc-500 transition-colors">
                <i data-lucide="panel-left-close" class="w-4 h-4"></i>
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-brand-dark relative">
        <header
            class="h-20 border-b border-white/10 bg-brand-panel/95 backdrop-blur-md flex items-center justify-between px-8 z-30">
            <div class="flex items-center gap-4 flex-1">
                <div class="flex items-center gap-4 text-sm text-zinc-500">
                    <i data-lucide="home" class="w-4 h-4 text-zinc-600"></i>
                    <i data-lucide="chevron-right" class="w-3 h-3 text-zinc-700"></i>
                    <span id="page-title" class="text-brand-orange font-semibold capitalize tracking-wide text-lg">Video
                        Calls</span>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <button onclick="videoCaller.startNewCall()" id="start-call-btn"
                    class="flex items-center gap-2 px-4 py-2 bg-brand-orange hover:bg-orange-600 text-white rounded-lg text-sm font-medium transition-all shadow-lg shadow-orange-900/20">
                    <i data-lucide="video" class="w-4 h-4"></i> New Call
                </button>
                <button onclick="videoCaller.refresh()" id="refresh-sessions-btn"
                    class="flex items-center gap-2 px-3 py-1.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-xs font-medium transition-all text-zinc-300">
                    <i data-lucide="refresh-cw" class="w-3 h-3" id="refresh-icon"></i> Refresh
                </button>
            </div>
        </header>

        <!-- Video Call Content -->
        <div class="flex-1 overflow-hidden flex">
            <!-- Left: Active Sessions List -->
            <div class="w-80 border-r border-white/10 bg-brand-panel/50 p-6 overflow-y-auto custom-scrollbar">
                <h3 class="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-4">Active Sessions</h3>
                <div id="sessions-list" class="space-y-3">
                    <div class="text-center py-12 text-zinc-500">
                        <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 animate-spin"></i>
                        <div>Loading sessions...</div>
                    </div>
                </div>
            </div>

            <!-- Right: Video Call Interface -->
            <div class="flex-1 flex flex-col bg-black/50">
                <div id="video-call-view" class="flex-1 flex items-center justify-center p-8">
                    <div class="text-center">
                        <i data-lucide="video" class="w-20 h-20 mx-auto mb-6 text-zinc-700"></i>
                        <h2 class="text-2xl font-bold text-white mb-2">Start or Join a Video Call</h2>
                        <p class="text-zinc-400 mb-8">Create a new call session or join an existing one</p>
                        <button onclick="videoCaller.startNewCall()"
                            class="px-8 py-4 bg-brand-orange hover:bg-orange-600 text-white rounded-xl font-medium transition-all shadow-lg shadow-orange-900/20">
                            <i data-lucide="video" class="w-5 h-5 inline mr-2"></i> Start New Call
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Video Call Modal/Interface -->
    <div id="video-call-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex-col">
        <div class="flex-1 flex items-center justify-center p-8 relative">
            <!-- Remote Video (Main) -->
            <div id="remote-video-container"
                class="w-full h-full max-w-6xl mx-auto relative bg-black rounded-2xl overflow-hidden">
                <video id="remote-video" autoplay playsinline></video>
                <div id="remote-video-placeholder"
                    class="absolute inset-0 flex items-center justify-center bg-brand-surface">
                    <div class="text-center">
                        <i data-lucide="video-off" class="w-20 h-20 mx-auto mb-4 text-zinc-700"></i>
                        <div class="text-zinc-400">Waiting for other participant...</div>
                    </div>
                </div>
            </div>

            <!-- Local Video (PiP) -->
            <div id="local-video-container"
                class="absolute bottom-24 right-8 w-64 h-48 bg-black rounded-xl overflow-hidden border-2 border-white/20 shadow-2xl">
                <video id="local-video" autoplay playsinline muted></video>
                <div id="local-video-placeholder"
                    class="absolute inset-0 flex items-center justify-center bg-brand-surface">
                    <div class="text-center">
                        <i data-lucide="user" class="w-12 h-12 mx-auto mb-2 text-zinc-700"></i>
                        <div class="text-xs text-zinc-400">You</div>
                    </div>
                </div>
            </div>

            <!-- Call Controls -->
            <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex items-center gap-4">
                <button onclick="videoCaller.toggleVideo()" id="toggle-video-btn"
                    class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 flex items-center justify-center text-white transition-all">
                    <i data-lucide="video" class="w-6 h-6"></i>
                </button>
                <button onclick="videoCaller.toggleAudio()" id="toggle-audio-btn"
                    class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 flex items-center justify-center text-white transition-all">
                    <i data-lucide="mic" class="w-6 h-6"></i>
                </button>
                <button onclick="videoCaller.endCall()" id="end-call-btn"
                    class="w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 flex items-center justify-center text-white transition-all shadow-lg shadow-red-900/50">
                    <i data-lucide="phone-off" class="w-7 h-7"></i>
                </button>
                <button onclick="videoCaller.toggleScreenShare()" id="toggle-screenshare-btn"
                    class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 flex items-center justify-center text-white transition-all">
                    <i data-lucide="monitor" class="w-6 h-6"></i>
                </button>
                <button onclick="videoCaller.toggleChat()" id="toggle-chat-btn"
                    class="w-14 h-14 rounded-full bg-white/10 hover:bg-white/20 border border-white/20 flex items-center justify-center text-white transition-all">
                    <i data-lucide="message-square" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Call Info -->
            <div class="absolute top-8 left-8 bg-black/60 backdrop-blur-md rounded-xl px-4 py-2 border border-white/20">
                <div class="flex items-center gap-3">
                    <span class="status-dot bg-red-500 animate-pulse"></span>
                    <div>
                        <div class="text-sm font-semibold text-white" id="call-session-name">Video Call</div>
                        <div class="text-xs text-zinc-400" id="call-participants">1 participant</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Call Modal -->
    <div id="start-call-modal"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="bg-brand-surface border border-white/20 rounded-2xl p-8 max-w-md w-full mx-4">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl font-bold text-white">Start Video Call</h2>
                <button onclick="videoCaller.hideStartCallModal()"
                    class="p-2 hover:bg-white/10 rounded-lg text-zinc-400 hover:text-white transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="start-call-form" onsubmit="videoCaller.createCall(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-zinc-400 mb-2">Call Name</label>
                    <input type="text" id="call-name" placeholder="e.g., Team Meeting"
                        class="w-full px-4 py-2 bg-black/20 border border-white/10 rounded-lg text-white placeholder-zinc-500 focus:outline-none focus:border-brand-orange/50 transition-all" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-zinc-400 mb-2">Call Type</label>
                    <select id="call-type"
                        class="w-full px-4 py-2 bg-black/20 border border-white/10 rounded-lg text-white focus:outline-none focus:border-brand-orange/50 transition-all">
                        <option value="call">Video Call</option>
                        <option value="meeting">Meeting</option>
                        <option value="stream">Stream</option>
                        <option value="screen_share">Screen Share</option>
                    </select>
                </div>
                <div class="flex items-center gap-4 pt-4">
                    <button type="submit"
                        class="flex-1 px-6 py-3 bg-brand-orange hover:bg-orange-600 text-white rounded-lg font-medium transition-all">
                        Start Call
                    </button>
                    <button type="button" onclick="videoCaller.hideStartCallModal()"
                        class="px-6 py-3 bg-white/5 hover:bg-white/10 border border-white/10 text-zinc-300 rounded-lg font-medium transition-all">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Theme System -->
    <link rel="stylesheet" href="/shared/themes/base.css">

    <!-- Shared Layout Script -->
    <script src="/shared/layout.js"></script>

    <!-- Page-Specific Script -->
    <script>
        const videoCaller = {
            currentSession: null,
            localStream: null,
            remoteStream: null,
            peerConnection: null,
            sessions: [],
            videoEnabled: true,
            audioEnabled: true,
            isInCall: false,

            async init() {
                lucide.createIcons();
                await this.loadSessions();
                this.setupMediaDevices();
            },

            async setupMediaDevices() {
                try {
                    // Check if getUserMedia is available
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        // Request permissions
                        await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    } else {
                        console.warn('getUserMedia not available - video calling may be limited');
                    }
                } catch (error) {
                    console.error('Media device setup error:', error);
                    showNotification('Camera/microphone access required for video calls', 'error');
                }
            },

            async loadSessions() {
                try {
                    const res = await API.get('video/sessions?status=active');
                    if (res.success && res.data) {
                        this.sessions = res.data || [];
                        this.renderSessions();
                    }
                } catch (error) {
                    console.error('Failed to load sessions:', error);
                    showNotification('Failed to load video sessions: ' + error.message, 'error');
                }
            },

            renderSessions() {
                const container = document.getElementById('sessions-list');
                if (!container) return;

                if (this.sessions.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-12 text-zinc-500">
                            <i data-lucide="video-off" class="w-12 h-12 mx-auto mb-4 text-zinc-700"></i>
                            <div class="text-sm font-medium text-zinc-400 mb-2">No active sessions</div>
                            <div class="text-xs text-zinc-600">Start a new call to begin</div>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                container.innerHTML = this.sessions.map(session => {
                    const started = new Date(session.started_at * 1000);
                    const participants = session.participants_json ? JSON.parse(session.participants_json) : [];

                    return `
                        <div class="bg-brand-surface border border-white/10 rounded-xl p-4 cursor-pointer hover:border-brand-orange/50 transition-colors"
                             onclick="videoCaller.joinSession('${session.id}')">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <h3 class="font-bold text-white text-sm mb-1">${this.escapeHtml(session.session_name || 'Video Call')}</h3>
                                    <p class="text-xs text-zinc-500">${session.session_type || 'call'}</p>
                                </div>
                                <span class="status-dot bg-red-500"></span>
                            </div>
                            <div class="flex items-center gap-3 text-xs text-zinc-500">
                                <span><i data-lucide="users" class="w-3 h-3 inline mr-1"></i> ${participants.length || 0} participants</span>
                                <span>â€¢</span>
                                <span>Started ${this.timeAgo(started)}</span>
                            </div>
                        </div>
                    `;
                }).join('');

                lucide.createIcons();
            },

            async startNewCall() {
                this.showStartCallModal();
            },

            async createCall(e) {
                e.preventDefault();
                try {
                    const sessionName = document.getElementById('call-name').value || 'Video Call';
                    const sessionType = document.getElementById('call-type').value || 'call';

                    const res = await API.post('video/sessions', {
                        session_name: sessionName,
                        session_type: sessionType,
                        host_id: 'user-samprimeaux', // TODO: Get from auth
                        video_enabled: true,
                        audio_enabled: true
                    });

                    if (res.success && res.data) {
                        this.hideStartCallModal();
                        await this.joinSession(res.data.id);
                        showNotification('Call started!', 'success');
                    } else {
                        showNotification('Failed to create call: ' + (res.error || 'Unknown error'), 'error');
                    }
                } catch (error) {
                    console.error('Create call error:', error);
                    showNotification('Failed to create call: ' + error.message, 'error');
                }
            },

            async joinSession(sessionId) {
                try {
                    // Get session details
                    const sessionRes = await API.get(`video/sessions/${sessionId}/sessions`);
                    if (!sessionRes.success || !sessionRes.data) {
                        throw new Error('Session not found');
                    }

                    this.currentSession = sessionRes.data;

                    // Join session via API
                    const joinRes = await API.post(`video/sessions/${sessionId}/join`, {
                        user_id: 'user-samprimeaux', // TODO: Get from auth
                        video_enabled: this.videoEnabled,
                        audio_enabled: this.audioEnabled
                    });

                    if (joinRes.success) {
                        this.isInCall = true;
                        this.showVideoInterface();
                        await this.startWebRTC(sessionId, joinRes.data);
                    } else {
                        throw new Error(joinRes.error || 'Failed to join session');
                    }
                } catch (error) {
                    console.error('Join session error:', error);
                    showNotification('Failed to join call: ' + error.message, 'error');
                }
            },

            async startWebRTC(sessionId, signalingInfo) {
                try {
                    // Get local media stream
                    this.localStream = await navigator.mediaDevices.getUserMedia({
                        video: this.videoEnabled,
                        audio: this.audioEnabled
                    });

                    // Set local video
                    const localVideo = document.getElementById('local-video');
                    if (localVideo) {
                        localVideo.srcObject = this.localStream;
                        const placeholder = document.getElementById('local-video-placeholder');
                        if (placeholder) placeholder.style.display = 'none';
                    }

                    // Create RTCPeerConnection (using free STUN servers for now)
                    const configuration = {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    };

                    this.peerConnection = new RTCPeerConnection(configuration);

                    // Add local stream tracks
                    this.localStream.getTracks().forEach(track => {
                        this.peerConnection.addTrack(track, this.localStream);
                    });

                    // Handle remote stream
                    this.peerConnection.ontrack = (event) => {
                        this.remoteStream = event.streams[0];
                        const remoteVideo = document.getElementById('remote-video');
                        if (remoteVideo) {
                            remoteVideo.srcObject = this.remoteStream;
                            const placeholder = document.getElementById('remote-video-placeholder');
                            if (placeholder) placeholder.style.display = 'none';
                        }
                    };

                    // Handle ICE candidates
                    this.peerConnection.onicecandidate = async (event) => {
                        if (event.candidate) {
                            // Send ICE candidate to signaling server (IAMSession Durable Object)
                            try {
                                await fetch(`${window.location.origin}/api/session/${sessionId}/webrtc/ice`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        candidate: event.candidate,
                                        from: 'user-samprimeaux' // TODO: Get from auth
                                    })
                                }).catch(() => { }); // Fire and forget
                            } catch (e) {
                                console.error('ICE candidate send error:', e);
                            }
                        }
                    };

                    // Create offer if we're the host
                    if (this.currentSession.host_id === 'user-samprimeaux') {
                        const offer = await this.peerConnection.createOffer();
                        await this.peerConnection.setLocalDescription(offer);

                        // Send offer to signaling server
                        await fetch(`${window.location.origin}/api/session/${sessionId}/webrtc/offer`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                offer: offer,
                                from: 'user-samprimeaux'
                            })
                        });
                    } else {
                        // Poll for offers/answers/ICE candidates (simplified - in production use WebSocket)
                        this.startSignalingPoll(sessionId);
                    }

                    showNotification('WebRTC connection initialized', 'success');
                } catch (error) {
                    console.error('WebRTC setup error:', error);
                    showNotification('Failed to start video: ' + error.message, 'error');
                }
            },

            async startSignalingPoll(sessionId) {
                // Poll for WebRTC signals from IAMSession Durable Object
                const pollInterval = setInterval(async () => {
                    if (!this.isInCall) {
                        clearInterval(pollInterval);
                        return;
                    }

                    try {
                        const res = await fetch(`${window.location.origin}/api/session/${sessionId}/webrtc/signals`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.success && data.data) {
                                // Handle offers
                                const offers = data.data.offers || [];
                                for (const offerData of offers) {
                                    if (offerData.from !== 'user-samprimeaux') {
                                        await this.handleOffer(offerData.offer);
                                    }
                                }

                                // Handle answers
                                const answers = data.data.answers || [];
                                for (const answerData of answers) {
                                    if (answerData.from !== 'user-samprimeaux') {
                                        await this.handleAnswer(answerData.answer);
                                    }
                                }

                                // Handle ICE candidates
                                const candidates = data.data.ice_candidates || [];
                                for (const candidateData of candidates) {
                                    if (candidateData.from !== 'user-samprimeaux') {
                                        await this.peerConnection.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
                                    }
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Signaling poll error:', error);
                    }
                }, 2000); // Poll every 2 seconds

                // Cleanup on call end
                this.signalingPollInterval = pollInterval;
            },

            async handleOffer(offer) {
                if (!this.peerConnection) return;
                await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await this.peerConnection.createAnswer();
                await this.peerConnection.setLocalDescription(answer);

                // Send answer to signaling server
                await fetch(`${window.location.origin}/api/session/${this.currentSession.id}/webrtc/answer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        answer: answer,
                        from: 'user-samprimeaux'
                    })
                });
            },

            async handleAnswer(answer) {
                if (!this.peerConnection) return;
                await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
            },

            showVideoInterface() {
                const modal = document.getElementById('video-call-modal');
                const view = document.getElementById('video-call-view');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
                if (view) {
                    view.style.display = 'none';
                }

                // Update UI
                if (this.currentSession) {
                    const nameEl = document.getElementById('call-session-name');
                    const participantsEl = document.getElementById('call-participants');
                    if (nameEl) nameEl.textContent = this.currentSession.session_name || 'Video Call';
                    if (participantsEl) {
                        const participants = this.currentSession.participants_json ? JSON.parse(this.currentSession.participants_json) : [];
                        participantsEl.textContent = `${participants.length || 1} participant${(participants.length || 1) !== 1 ? 's' : ''}`;
                    }
                }
            },

            hideVideoInterface() {
                const modal = document.getElementById('video-call-modal');
                const view = document.getElementById('video-call-view');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
                if (view) {
                    view.style.display = 'flex';
                }
            },

            async endCall() {
                if (this.currentSession) {
                    try {
                        await API.post(`video/sessions/${this.currentSession.id}/leave`, {
                            user_id: 'user-samprimeaux'
                        });
                    } catch (e) {
                        console.error('Leave session error:', e);
                    }
                }

                // Stop media streams
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }

                // Close peer connection
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }

                // Clear video elements
                const localVideo = document.getElementById('local-video');
                const remoteVideo = document.getElementById('remote-video');
                if (localVideo) {
                    localVideo.srcObject = null;
                    document.getElementById('local-video-placeholder').style.display = 'flex';
                }
                if (remoteVideo) {
                    remoteVideo.srcObject = null;
                    document.getElementById('remote-video-placeholder').style.display = 'flex';
                }

                // Clear intervals
                if (this.signalingPollInterval) {
                    clearInterval(this.signalingPollInterval);
                }

                this.isInCall = false;
                this.currentSession = null;
                this.hideVideoInterface();
                await this.loadSessions();
                showNotification('Call ended', 'info');
            },

            toggleVideo() {
                this.videoEnabled = !this.videoEnabled;
                if (this.localStream) {
                    const videoTrack = this.localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = this.videoEnabled;
                    }
                }

                const btn = document.getElementById('toggle-video-btn');
                if (btn) {
                    btn.classList.toggle('bg-red-500/20', !this.videoEnabled);
                    const icon = btn.querySelector('i');
                    if (icon) {
                        icon.setAttribute('data-lucide', this.videoEnabled ? 'video' : 'video-off');
                        lucide.createIcons();
                    }
                }
            },

            toggleAudio() {
                this.audioEnabled = !this.audioEnabled;
                if (this.localStream) {
                    const audioTrack = this.localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = this.audioEnabled;
                    }
                }

                const btn = document.getElementById('toggle-audio-btn');
                if (btn) {
                    btn.classList.toggle('bg-red-500/20', !this.audioEnabled);
                    const icon = btn.querySelector('i');
                    if (icon) {
                        icon.setAttribute('data-lucide', this.audioEnabled ? 'mic' : 'mic-off');
                        lucide.createIcons();
                    }
                }
            },

            async toggleScreenShare() {
                try {
                    if (!this.isScreenSharing) {
                        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                        const screenTrack = screenStream.getVideoTracks()[0];

                        // Replace video track
                        const sender = this.peerConnection?.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender && screenTrack) {
                            await sender.replaceTrack(screenTrack);
                        }

                        // Update local video
                        const localVideo = document.getElementById('local-video');
                        if (localVideo) {
                            localVideo.srcObject = screenStream;
                        }

                        this.isScreenSharing = true;
                        showNotification('Screen sharing started', 'success');
                    } else {
                        // Stop screen share and restore camera
                        const cameraStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                        const cameraTrack = cameraStream.getVideoTracks()[0];

                        const sender = this.peerConnection?.getSenders().find(s => s.track && s.track.kind === 'video');
                        if (sender && cameraTrack) {
                            await sender.replaceTrack(cameraTrack);
                        }

                        const localVideo = document.getElementById('local-video');
                        if (localVideo && this.localStream) {
                            localVideo.srcObject = this.localStream;
                        }

                        this.isScreenSharing = false;
                        showNotification('Screen sharing stopped', 'info');
                    }
                } catch (error) {
                    console.error('Screen share error:', error);
                    showNotification('Screen sharing failed: ' + error.message, 'error');
                }
            },

            toggleChat() {
                // TODO: Implement in-call chat overlay
                showNotification('Chat feature coming soon', 'info');
            },

            showStartCallModal() {
                const modal = document.getElementById('start-call-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    document.getElementById('call-name')?.focus();
                }
            },

            hideStartCallModal() {
                const modal = document.getElementById('start-call-modal');
                if (modal) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    document.getElementById('start-call-form')?.reset();
                }
            },

            async refresh() {
                const btn = document.getElementById('refresh-sessions-btn');
                const icon = document.getElementById('refresh-icon');
                if (icon) icon.classList.add('animate-spin');
                if (btn) btn.disabled = true;

                try {
                    await this.loadSessions();
                    showNotification('Sessions refreshed', 'success');
                } finally {
                    if (icon) icon.classList.remove('animate-spin');
                    if (btn) btn.disabled = false;
                }
            },

            timeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                if (seconds < 60) return 'just now';
                const minutes = Math.floor(seconds / 60);
                if (minutes < 60) return `${minutes}m ago`;
                const hours = Math.floor(minutes / 60);
                if (hours < 24) return `${hours}h ago`;
                const days = Math.floor(hours / 24);
                return `${days}d ago`;
            },

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        window.addEventListener('DOMContentLoaded', () => {
            videoCaller.init();
        });

        window.addEventListener('beforeunload', () => {
            if (videoCaller.isInCall) {
                videoCaller.endCall();
            }
        });
    </script>
    <script src="/shared/layout-loader.js"></script>
</body>

</html>