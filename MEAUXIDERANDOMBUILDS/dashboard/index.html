<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Overview | InnerAnimal Media OS</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            orange: '#ff6b00',
                            red: '#dc2626',
                            dark: '#050507',
                            panel: '#0a0a0f',
                            surface: '#171717'
                        }
                    }
                }
            }
        }
    </script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Dashboard Container CSS -->
    <link rel="stylesheet" href="/shared/dashboard-container.css">

    <!-- Theme System CSS (if available) -->
    <link rel="stylesheet" href="/shared/themes/meaux-theme-library.css">

    <!-- Custom Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: var(--dashboard-bg, #050507);
            color: var(--dashboard-text-primary, rgba(255, 255, 255, 0.95));
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
    </style>

</head>

<body>
    <!-- Dashboard Layout Container -->
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content Area -->
        <main class="dashboard-main">
            <!-- Dashboard Header -->
            <header class="dashboard-header" id="dashboard-header-container"></header>

            <!-- Dashboard Content -->
            <div class="dashboard-content custom-scrollbar">
                <div class="dashboard-content-inner">
                    <div class="page-container">
                        <div class="page-header">
                            <h1 class="page-title" id="pageTitle">Dashboard Overview</h1>
                            <p class="page-subtitle" id="pageSubtitle">Welcome back, Sam. Your systems are running
                                optimally.</p>
                        </div>

                        <div class="dashboard-grid" id="dashboardContent">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <div class="card-title">Active Projects</div>
                                    <div class="card-icon">
                                        <i data-lucide="briefcase" class="w-5 h-5"></i>
                                    </div>
                                </div>
                                <div class="card-value" id="activeProjectsCount">0</div>
                                <div class="card-label">Across all brands</div>
                                <div class="card-trend up">↑ Loading...</div>
                            </div>

                            <div class="dashboard-card">
                                <div class="card-header">
                                    <div class="card-title">Client Projects</div>
                                    <div class="card-icon">
                                        <i data-lucide="users" class="w-5 h-5"></i>
                                    </div>
                                </div>
                                <div class="card-value" id="clientProjectsCount">0</div>
                                <div class="card-label">Active engagements</div>
                                <div class="card-trend up">↑ Loading...</div>
                            </div>

                            <div class="dashboard-card">
                                <div class="card-header">
                                    <div class="card-title">Tasks Completed</div>
                                    <div class="card-icon">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                                    </div>
                                </div>
                                <div class="card-value" id="tasksCompletedCount">0</div>
                                <div class="card-label">This month</div>
                                <div class="card-trend up">↑ Loading...</div>
                            </div>

                            <div class="dashboard-card">
                                <div class="card-header">
                                    <div class="card-title">Database Queries</div>
                                    <div class="card-icon">
                                        <i data-lucide="database" class="w-5 h-5"></i>
                                    </div>
                                </div>
                                <div class="card-value">1.2M</div>
                                <div class="card-label">MeauxOS operations</div>
                                <div class="card-trend up">↑ Optimal performance</div>
                            </div>

                            <div class="dashboard-card">
                                <div class="card-header">
                                    <div class="card-title">Worker Deployments</div>
                                    <div class="card-icon">
                                        <i data-lucide="rocket" class="w-5 h-5"></i>
                                    </div>
                                </div>
                                <div class="card-value" id="workersCount">0</div>
                                <div class="card-label">Active workers</div>
                                <div class="card-trend up">↑ Loading...</div>
                            </div>

                            <div class="dashboard-card">
                                <div class="card-header">
                                    <div class="card-title">Analytics Traffic</div>
                                    <div class="card-icon">
                                        <i data-lucide="trending-up" class="w-5 h-5"></i>
                                    </div>
                                </div>
                                <div class="card-value">47.2K</div>
                                <div class="card-label">Monthly visitors</div>
                                <div class="card-trend up">↑ 18% growth</div>
                            </div>

                            <div class="dashboard-card">
                                <div class="card-header">
                                    <div class="card-title">Integrations</div>
                                    <div class="card-icon">
                                        <i data-lucide="link" class="w-5 h-5"></i>
                                    </div>
                                </div>
                                <div class="card-value" id="connected-integrations">0/0</div>
                                <div class="card-label">Connected services</div>
                                <div class="card-trend" id="integration-status-text">Loading...</div>
                                <a href="/dashboard/settings" class="card-link">Manage Integrations →</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Menu Button (will be injected by sidebar) -->

    <!-- Shared Layout Scripts -->
    <script src="/shared/layout.js"></script>
    <script src="/shared/dashboard-layout.js"></script>

    <!-- Load Sidebar and Header -->
    <script>
        async function loadDashboardComponents() {
            // Load sidebar
            try {
                const sidebarRes = await fetch('/shared/sidebar.html');
                if (sidebarRes.ok) {
                    const sidebarHtml = await sidebarRes.text();
                    const sidebarContainer = document.getElementById('sidebar-container');
                    if (sidebarContainer) {
                        sidebarContainer.innerHTML = sidebarHtml;
                        // Reinitialize icons after sidebar loads
                        if (typeof lucide !== 'undefined') {
                            setTimeout(() => lucide.createIcons(), 100);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading sidebar:', error);
            }

            // Load header
            try {
                const headerRes = await fetch('/shared/header.html');
                if (headerRes.ok) {
                    const headerHtml = await headerRes.text();
                    const headerContainer = document.getElementById('dashboard-header-container');
                    if (headerContainer) {
                        headerContainer.innerHTML = headerHtml;
                        // Update page title
                        const pageTitle = document.getElementById('page-title');
                        if (pageTitle) {
                            pageTitle.textContent = 'Dashboard Overview';
                        }
                        // Reinitialize icons
                        if (typeof lucide !== 'undefined') {
                            setTimeout(() => lucide.createIcons(), 100);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading header:', error);
            }
        }

        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadDashboardComponents);
        } else {
            loadDashboardComponents();
        }
    </script>

    <!-- Page-specific scripts -->
    <script>
        // Handle OAuth parameters (clean URL)
        (function () {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            let needsCleanup = false;

            if (code) {
                urlParams.delete('code');
                needsCleanup = true;
            }

            if (state) {
                urlParams.delete('state');
                needsCleanup = true;
            }

            if (needsCleanup) {
                const newUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
                window.history.replaceState({}, document.title, newUrl);
            }
        })();

        // Dashboard Data Loading
        async function loadDashboardData() {
            try {
                const API_BASE = window.location.origin;

                // Fetch stats
                const statsRes = await fetch(`${API_BASE}/api/stats`);

                if (!statsRes.ok) {
                    throw new Error(`Stats API returned ${statsRes.status}`);
                }

                const stats = await statsRes.json();

                if (!stats.success || !stats.data) {
                    console.error('Stats API error:', stats);
                    throw new Error('Invalid stats response');
                }

                const data = stats.data;

                // Helper to update card value and trend
                function updateCard(cardId, value, trendText = null, trendClass = 'up') {
                    const cardEl = document.getElementById(cardId);
                    if (!cardEl) return;

                    cardEl.textContent = value;

                    // Find trend element (next sibling of next sibling - card-label)
                    let trendEl = cardEl.nextElementSibling; // card-label
                    if (trendEl) {
                        trendEl = trendEl.nextElementSibling; // card-trend
                        if (trendEl && trendEl.classList.contains('card-trend')) {
                            if (trendText !== null) {
                                trendEl.textContent = trendText;
                                trendEl.className = `card-trend ${trendClass}`;
                            }
                        }
                    }
                }

                // Update Active Projects (from active_projects or deployments)
                const activeProjects = data.active_projects ?? data.deployments ?? data.projects ?? 0;
                updateCard('activeProjectsCount', activeProjects, activeProjects > 0 ? '↑ Active' : '— No projects', activeProjects > 0 ? 'up' : '');

                // Update Client Projects (from active_clients or clients)
                const clientProjects = data.active_clients ?? data.clients ?? 0;
                updateCard('clientProjectsCount', clientProjects, clientProjects > 0 ? '↑ Active' : '— No clients', clientProjects > 0 ? 'up' : '');

                // Update Tasks Completed (placeholder for now - no tasks table yet)
                updateCard('tasksCompletedCount', 0, '— No tasks system', '');

                // Update Workers (from workers.total or workers number)
                const workers = typeof data.workers === 'object' ? (data.workers?.total ?? 0) : (data.workers ?? 0);
                updateCard('workersCount', workers, workers > 0 ? '↑ Active' : '— No workers', workers > 0 ? 'up' : '');

                // Update integrations count
                const integrationsEl = document.getElementById('connected-integrations');
                const integrationsStatusEl = document.getElementById('integration-status-text');
                if (integrationsEl) {
                    integrationsEl.textContent = '0/0';
                    if (integrationsStatusEl) {
                        integrationsStatusEl.textContent = 'No integrations connected';
                    }
                }

                // Reinitialize icons after updates
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Update error states
                document.querySelectorAll('.card-trend').forEach(el => {
                    if (el.textContent.includes('Loading')) {
                        el.textContent = '— Error loading';
                        el.className = 'card-trend';
                    }
                });
            }
        }

        // Load dashboard data after components load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // Wait for sidebar/header to load, then load data
                setTimeout(loadDashboardData, 1000);
                // Auto-refresh every 30 seconds
                setInterval(loadDashboardData, 30000);
            });
        } else {
            // Already loaded, wait a bit then load data
            setTimeout(loadDashboardData, 1000);
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardData, 30000);
        }
    </script>

</body>

</html>