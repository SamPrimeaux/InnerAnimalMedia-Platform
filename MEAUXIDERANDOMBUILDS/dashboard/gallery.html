<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallery | InnerAnimalMedia OS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        brand: {
                            orange: '#ff6b00',
                            red: '#dc2626',
                            dark: '#050507',
                            panel: '#0a0a0f',
                            surface: '#171717'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="/shared/themes/base.css">
    <link rel="stylesheet" href="/shared/themes/inneranimal-media.css">
    <style>
        body {
            background-color: #050507;
            color: #f4f4f5;
            overflow: hidden;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #ff6b00;
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            box-shadow: 0 0 10px currentColor;
        }

        .gallery-item {
            aspect-ratio: 1;
            overflow: hidden;
            position: relative;
        }

        .gallery-item img {
            transition: transform 0.3s ease;
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }
    </style>
    <link rel="stylesheet" href="/shared/themes/meaux-theme-library.css">
</head>

<body class="flex h-screen selection:bg-orange-500/30">
    <!-- Sidebar will be loaded by dashboard-layout-loader.js -->
    <div id="sidebar-container"></div>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-brand-dark relative">
        <!-- Header will be loaded by dashboard-layout-loader.js -->
        <div id="header-container"></div>

        <div class="flex-1 overflow-y-auto p-8 custom-scrollbar">
            <div class="space-y-6 animate-fade-in">
                <!-- Page Header -->
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h1 class="text-3xl font-bold text-white mb-2">Gallery</h1>
                        <p class="text-zinc-400 text-sm">Browse and manage your media library</p>
                    </div>
                    <button onclick="showUploadModal()"
                        class="flex items-center gap-2 px-4 py-2.5 bg-brand-orange hover:bg-orange-600 text-white rounded-xl text-sm font-medium transition-all shadow-lg shadow-orange-900/20">
                        <i data-lucide="upload" class="w-4 h-4"></i> Upload Image
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-brand-surface border border-white/10 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-zinc-500 uppercase tracking-wider">Total Images</span>
                            <i data-lucide="image" class="w-5 h-5 text-blue-400"></i>
                        </div>
                        <div class="text-3xl font-bold text-white" id="total-images">-</div>
                    </div>
                    <div class="bg-brand-surface border border-white/10 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-zinc-500 uppercase tracking-wider">Total Size</span>
                            <i data-lucide="hard-drive" class="w-5 h-5 text-purple-400"></i>
                        </div>
                        <div class="text-3xl font-bold text-white" id="total-size">-</div>
                    </div>
                    <div class="bg-brand-surface border border-white/10 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-zinc-500 uppercase tracking-wider">This Month</span>
                            <i data-lucide="calendar" class="w-5 h-5 text-emerald-400"></i>
                        </div>
                        <div class="text-3xl font-bold text-white" id="month-uploads">-</div>
                    </div>
                    <div class="bg-brand-surface border border-white/10 rounded-xl p-6">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-zinc-500 uppercase tracking-wider">Storage Used</span>
                            <i data-lucide="database" class="w-5 h-5 text-yellow-400"></i>
                        </div>
                        <div class="text-3xl font-bold text-white" id="storage-used">-</div>
                    </div>
                </div>

                <!-- Filters and Search -->
                <div class="flex items-center gap-4 flex-wrap">
                    <div class="flex-1 max-w-md">
                        <div class="relative">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"></i>
                            <input type="text" id="gallery-search" placeholder="Search images..."
                                class="w-full pl-10 pr-4 py-2.5 bg-black/20 border border-white/10 rounded-xl text-sm text-white placeholder-zinc-500 focus:outline-none focus:border-brand-orange/50 focus:bg-black/30 transition-all" />
                        </div>
                    </div>
                    <select id="type-filter"
                        class="px-4 py-2.5 bg-black/20 border border-white/10 rounded-xl text-sm text-white focus:outline-none focus:border-brand-orange/50 transition-all">
                        <option value="all">All Types</option>
                        <option value="image">Images</option>
                        <option value="video">Videos</option>
                        <option value="document">Documents</option>
                    </select>
                    <button onclick="loadGallery()"
                        class="flex items-center gap-2 px-4 py-2.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl text-sm font-medium transition-all text-zinc-300">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Refresh
                    </button>
                </div>

                <!-- Gallery Grid -->
                <div id="gallery-container" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div class="col-span-full text-center py-12 text-zinc-500">
                        <i data-lucide="loader" class="w-8 h-8 mx-auto mb-4 animate-spin"></i>
                        <div>Loading gallery...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Quick-Connect Container -->
    <div id="quick-connect-container"></div>

    <!-- Dashboard Layout Loader (loads unified sidebar and header) -->
    <script src="/shared/dashboard-layout-loader.js"></script>
    <script src="/shared/layout.js"></script>
    <script>
        const API_BASE = window.location.origin;
        let allImages = [];

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = new Date(typeof timestamp === 'number' ? timestamp * 1000 : timestamp);
            return date.toLocaleDateString();
        }

        function renderGalleryItem(image) {
            const imageUrl = image.url || image.preview_url || `https://imagedelivery.net/${image.cloudflare_image_id || 'placeholder'}/image`;
            const fileSize = image.file_size ? formatFileSize(image.file_size) : '';
            const fileName = image.name || image.filename || 'Untitled';

            return `
                <div class="gallery-item bg-brand-surface border border-white/10 rounded-xl overflow-hidden group cursor-pointer"
                    onclick="viewImage('${image.id || image.url}')">
                    <div class="relative h-full bg-black/20">
                        <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(fileName)}"
                            class="w-full h-full object-cover"
                            onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 400 400%27%3E%3Crect fill=%27%23171717%27 width=%27400%27 height=%27400%27/%3E%3Ctext fill=%27%23737373%27 font-family=%27sans-serif%27 font-size=%2720%27 x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27%3EImage%3C/text%3E%3C/svg%3E'" />
                        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-all flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <div class="flex items-center gap-2">
                                <button onclick="event.stopPropagation(); downloadImage('${image.id || image.url}')"
                                    class="p-2 bg-white/10 hover:bg-white/20 rounded-lg backdrop-blur-sm">
                                    <i data-lucide="download" class="w-4 h-4 text-white"></i>
                                </button>
                                <button onclick="event.stopPropagation(); deleteImage('${image.id || image.url}')"
                                    class="p-2 bg-red-500/20 hover:bg-red-500/30 rounded-lg backdrop-blur-sm">
                                    <i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 border-t border-white/5">
                        <div class="text-xs font-medium text-white truncate mb-1">${escapeHtml(fileName)}</div>
                        ${fileSize ? `<div class="text-xs text-zinc-500">${fileSize}</div>` : ''}
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadGallery() {
            try {
                // Load images from API (placeholder - using images endpoint if available)
                const response = await fetch(`${API_BASE}/api/images?per_page=100`);
                const data = await response.json();

                if (data.success) {
                    const images = data.data || [];
                    allImages = images;

                    // Update stats
                    document.getElementById('total-images').textContent = images.length;
                    const totalSize = images.reduce((sum, img) => sum + (img.file_size || 0), 0);
                    document.getElementById('total-size').textContent = formatFileSize(totalSize);
                    
                    // Calculate month uploads
                    const now = new Date();
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    const monthImages = images.filter(img => {
                        const uploadDate = new Date((img.created_at || 0) * 1000);
                        return uploadDate >= monthStart;
                    });
                    document.getElementById('month-uploads').textContent = monthImages.length;
                    document.getElementById('storage-used').textContent = formatFileSize(totalSize);

                    // Render gallery
                    filterGallery();
                    lucide.createIcons();
                } else {
                    // If images API doesn't exist, show placeholder
                    document.getElementById('total-images').textContent = '0';
                    document.getElementById('total-size').textContent = '0 B';
                    document.getElementById('month-uploads').textContent = '0';
                    document.getElementById('storage-used').textContent = '0 B';
                    
                    document.getElementById('gallery-container').innerHTML = `
                        <div class="col-span-full text-center py-12 text-zinc-500">
                            <i data-lucide="image" class="w-12 h-12 mx-auto mb-4 text-zinc-700"></i>
                            <div class="font-medium mb-2">No images yet</div>
                            <div class="text-sm">Upload your first image to get started</div>
                            <button onclick="showUploadModal()" class="mt-4 px-4 py-2 bg-brand-orange text-white rounded-lg hover:bg-orange-600 transition-colors">
                                <i data-lucide="upload" class="w-4 h-4 inline mr-2"></i> Upload Image
                            </button>
                        </div>
                    `;
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading gallery:', error);
                // Show empty state on error
                document.getElementById('total-images').textContent = '0';
                document.getElementById('total-size').textContent = '0 B';
                document.getElementById('month-uploads').textContent = '0';
                document.getElementById('storage-used').textContent = '0 B';
                
                document.getElementById('gallery-container').innerHTML = `
                    <div class="col-span-full text-center py-12 text-zinc-500">
                        <i data-lucide="image" class="w-12 h-12 mx-auto mb-4 text-zinc-700"></i>
                        <div class="font-medium mb-2">Gallery ready</div>
                        <div class="text-sm">Upload images to start your gallery</div>
                    </div>
                `;
                lucide.createIcons();
            }
        }

        function filterGallery() {
            const searchQuery = document.getElementById('gallery-search')?.value.trim().toLowerCase() || '';
            const typeFilter = document.getElementById('type-filter')?.value || 'all';

            let filtered = allImages;

            // Apply search filter
            if (searchQuery) {
                filtered = filtered.filter(image =>
                    (image.name && image.name.toLowerCase().includes(searchQuery)) ||
                    (image.filename && image.filename.toLowerCase().includes(searchQuery)) ||
                    (image.tags && image.tags.toLowerCase().includes(searchQuery))
                );
            }

            // Apply type filter
            if (typeFilter !== 'all') {
                filtered = filtered.filter(image => {
                    const imageType = image.type || image.mime_type || '';
                    return imageType.includes(typeFilter);
                });
            }

            const container = document.getElementById('gallery-container');
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-zinc-500">
                        <i data-lucide="search" class="w-12 h-12 mx-auto mb-4 text-zinc-700"></i>
                        <div class="font-medium mb-2">No images found</div>
                        <div class="text-sm">${searchQuery ? 'Try a different search term' : 'Upload your first image to get started'}</div>
                    </div>
                `;
            } else {
                container.innerHTML = filtered.map(renderGalleryItem).join('');
            }

            lucide.createIcons();
        }

        function viewImage(imageId) {
            // TODO: Open image lightbox/viewer
            alert('Image viewer coming soon for: ' + imageId);
        }

        function downloadImage(imageId) {
            // TODO: Download image
            alert('Download image: ' + imageId);
        }

        function deleteImage(imageId) {
            if (confirm('Are you sure you want to delete this image?')) {
                // TODO: Delete image via API
                alert('Delete image: ' + imageId);
                loadGallery();
            }
        }

        function showUploadModal() {
            // TODO: Open upload modal
            alert('Upload image modal coming soon!');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Initialize search and filters
            const searchInput = document.getElementById('gallery-search');
            const typeFilter = document.getElementById('type-filter');

            if (searchInput) {
                searchInput.addEventListener('input', () => filterGallery());
            }
            if (typeFilter) {
                typeFilter.addEventListener('change', () => filterGallery());
            }

            loadGallery();
        });
    </script>

    <!-- Layout Loader -->
    <script src="/shared/layout-loader.js"></script>
    <script src="/shared/onboarding-wizard.js"></script>
</body>

</html>
